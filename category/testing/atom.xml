<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Testing | Icebergist]]></title>
  <link href="http://icebergist.com/category/testing/atom.xml" rel="self"/>
  <link href="http://icebergist.com/"/>
  <updated>2016-03-24T13:23:19+01:00</updated>
  <id>http://icebergist.com/</id>
  <author>
    <name><![CDATA[Orange Iceberg]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Headless Firefox in Ubuntu on VirtualBox for Cucumber testing]]></title>
    <link href="http://icebergist.com/posts/headless-firefox-in-ubuntu-on-virtual-box-for-cucumber-testing/"/>
    <updated>2015-12-03T10:12:56+01:00</updated>
    <id>http://icebergist.com/posts/headless-firefox-in-ubuntu-on-virtual-box-for-cucumber-testing</id>
    <content type="html"><![CDATA[<p>If you use <a href="http://www.vagrantup.com/downloads.html">Vagrant</a>, <a href="https://www.virtualbox.org/">VirtualBox</a> and Ubuntu to build your Rails apps and you want to test it with Cucumber scenarios, this is the right post for you. By default Vagrant and VirtualBox use Ubuntu without an X server and GUI.</p>

<p>Everything goes well until you need <code>@javascript</code> flag for your cucumber scenario. <code>@javascript</code> uses a javascript-aware system to process web requests (e.g. Selenium) instead of the default (non-javascript-aware) webrat browser.</p>

<h3>Install Mozilla Firefox</h3>

<p>Selenium WebDriver is flexible and lets you run selenium headless in servers with no display. But in order to run, Selenium needs to launch a browser. If there is no display to the machine, the browsers are not launched. So in order to use selenium, you need to fake a display and let selenium and the browser think they are running in a machine with a display.</p>

<p>Install latest version of Mozilla Firefox:</p>

<p><code>sudo apt-get install firefox</code></p>

<p>Since Ubuntu is running without a X server Selenium cannot start Firefox because it requires an X server.</p>

<h3>Setting up virtual X server</h3>

<p>Virtual X server is required to make browsers run normally by making them believe there is a display available, although it doesn&rsquo;t create any visible windows.</p>

<!--more-->


<p>Xvfb (X Virtual FrameBuffer) works fine for this. Xvfb lets you run X-Server in machines with no display devices.</p>

<p>Install xvfb on ubuntu:</p>

<p><code>sudo apt-get install xvfb</code></p>

<p>Lets run the Xvfb service in a display number which is less likely to clash even if you add a display at a later stage. Display 10 will do fine.</p>

<p><code>sudo Xvfb :10 -ac</code></p>

<p>The parameter -ac makes xvfb run with access control off. The server should be running now.</p>

<h3>Headless Firefox</h3>

<p>Before you can run a browser, you need to set the environment variable DISPLAY with the display number at which xvfb is running.</p>

<p>Open new tab in terminal and set the DISPLAY variable:</p>

<p><code>export DISPLAY=:10</code></p>

<p>and start mozilla firefox:</p>

<p><code>firefox</code></p>

<p>Now you run firefox headlessly in Ubuntu, and you can run your cucumber scenarios with <code>@javascript</code> flag.</p>

<h3>Start virtual X server automatically</h3>

<p>To run your X server automatically, after installing Xvfb, you will need to:</p>

<ul>
<li>put content of <a href="https://gist.github.com/basti/2db0b71e893ee4d6d015">this gist</a> in <code>/etc/init.d/xvfb</code> (hint use <code>sudo wget</code> command to do that)</li>
<li>make it executable <code>sudo chmod a+x /etc/init.d/xvfb</code></li>
<li>start xvfb on display number 10 <code>export DISPLAY=:10</code></li>
<li>run X server <code>sudo /etc/init.d/xvfb start</code></li>
<li>when you want to stop X server <code>sudo /etc/init.d/xvfb stop</code></li>
</ul>


<p>This is my way to run firefox headlessly in Virtual box Ubuntu, and to run cucumber scenarios with <code>@javascript</code> flag.</p>

<p>References:</p>

<ul>
<li><a href="http://www.installationpage.com/selenium/how-to-run-selenium-headless-firefox-in-ubuntu/">Selenium Headless Automated Testing in Ubuntu</a></li>
<li><a href="https://gist.github.com/jterrace/2911875">Xvfb init script for Ubuntu</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RSpec and FactoryGirl setup for testing Carrierwave uploaders]]></title>
    <link href="http://icebergist.com/posts/rspec-and-factorygirl-setup-for-testing-carrierwave-uploaders"/>
    <updated>2013-09-07T10:00:00+02:00</updated>
    <id>http://icebergist.com/posts/rspec-and-factorygirl-setup-for-testing-carrierwave-uploaders</id>
    <content type="html"><![CDATA[<p>Assume that you have the usual setup with model (MyFile) using simple Carrierwave uploader (MyFileUploader):</p>

<pre># app/models/my_file.rb
class MyFile &lt; ActiveRecord::Base
  mount_uploader :file, MyFileUploader
end</pre>


<p>To be able to test Carrierwave uploaders with RSpec using FactoryGirl factories you need:</p>

<ul>
<li><span style="line-height: 13px;">define factory with uploaded file</span></li>
<li>modify test environment storage so test file uploads are separated from other uploads</li>
<li>turn off image processing to speed up tests</li>
<li>perform cleanup after each test</li>
</ul>


<h2>Define factory</h2>

<pre># spec/factories/my_files.rb
FactoryGirl.define do
 factory :my_file do
   photo Rack::Test::UploadedFile.new(File.open(File.join(Rails.root, '/spec/fixtures/myfiles/myfile.jpg')))
 end
end</pre>


<h2>Setup Carrierwave</h2>

<p>First we need to make sure Carrierwave is using local file system for storage and to disable file processing for testing environments. Disabling file processing will speed up tests considerably. We can do that by adding following to Carrierwave initializer:</p>

<pre>if Rails.env.test? || Rails.env.cucumber?
  CarrierWave.configure do |config|
    config.storage = :file
    config.enable_processing = false
  end
end</pre>


<p>Next we should separate test uploads from any other uploads. We can do that by modifying cache_dir and store_dir methods for all Carrierwave models (i.e. all models that are descendants ofÂ CarrierWave::Uploader::Base). So the whole Carrierwave initializer looks something like:</p>

<pre># config/initializers/carrierwave.rb
if Rails.env.test? || Rails.env.cucumber?
  CarrierWave.configure do |config|
    config.storage = :file
    config.enable_processing = false
  end

  # make sure our uploader is auto-loaded
  MyFileUploader

  # use different dirs when testing
  CarrierWave::Uploader::Base.descendants.each do |klass|
    next if klass.anonymous?
    klass.class_eval do
      def cache_dir
        "#{Rails.root}/spec/support/uploads/tmp"
      end

      def store_dir
        "#{Rails.root}/spec/support/uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}"
      end
    end
  end
end</pre>


<h2>Clean up uploaded files</h2>

<p>Using factory defined above will create uploaded files in cache_dir and store_dir. These are just temporary files and should be removed after each test, so each of them has a clean slate. By adding after :each hook in RSpec configuration block we can remove these files simply by deleting spec/support/uploads dir.</p>

<pre># spec_helper.rb
RSpec.configure do |config|
  config.after(:each) do
    if Rails.env.test? || Rails.env.cucumber?
      FileUtils.rm_rf(Dir["#{Rails.root}/spec/support/uploads"])
    end 
  end
end</pre>

]]></content>
  </entry>
  
</feed>
